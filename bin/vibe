#!/usr/bin/env bash
#
# Vibe CLI - Main entry point
#
# This script:
# 1. Ensures Python 3.11+ is available
# 2. Creates/activates a virtual environment in .vibe/.venv/
# 3. Installs dependencies from pyproject.toml
# 4. Dispatches to the appropriate Python command
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Find the repo root (where this script's directory's parent is)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"

VENV_DIR="$REPO_ROOT/.vibe/.venv"
PYTHON_MIN_VERSION="3.11"

# Function to check Python version
check_python_version() {
    local python_cmd="$1"
    local version

    if ! command -v "$python_cmd" &> /dev/null; then
        return 1
    fi

    version=$("$python_cmd" -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')" 2>/dev/null)

    if [[ -z "$version" ]]; then
        return 1
    fi

    # Compare versions
    local min_major min_minor cur_major cur_minor
    IFS='.' read -r min_major min_minor <<< "$PYTHON_MIN_VERSION"
    IFS='.' read -r cur_major cur_minor <<< "$version"

    if (( cur_major > min_major )) || (( cur_major == min_major && cur_minor >= min_minor )); then
        echo "$python_cmd"
        return 0
    fi

    return 1
}

# Find suitable Python
find_python() {
    local python_cmd

    # Try common Python commands in order of preference
    for cmd in python3.12 python3.11 python3 python; do
        if python_cmd=$(check_python_version "$cmd"); then
            echo "$python_cmd"
            return 0
        fi
    done

    return 1
}

# Setup virtual environment
setup_venv() {
    local python_cmd="$1"

    if [[ ! -d "$VENV_DIR" ]]; then
        echo -e "${YELLOW}Creating virtual environment...${NC}"
        "$python_cmd" -m venv "$VENV_DIR"
    fi

    # Activate venv
    source "$VENV_DIR/bin/activate"

    # Check if deps need installing
    if [[ ! -f "$VENV_DIR/.deps_installed" ]] || [[ "$REPO_ROOT/pyproject.toml" -nt "$VENV_DIR/.deps_installed" ]]; then
        echo -e "${YELLOW}Installing dependencies...${NC}"
        pip install -q -e "$REPO_ROOT"
        touch "$VENV_DIR/.deps_installed"
    fi
}

# Main
main() {
    local python_cmd

    # Find Python
    if ! python_cmd=$(find_python); then
        echo -e "${RED}Error: Python $PYTHON_MIN_VERSION or later is required.${NC}"
        echo "Please install Python 3.11+ and try again."
        exit 1
    fi

    # Setup venv
    setup_venv "$python_cmd"

    # Run the CLI
    cd "$REPO_ROOT"
    python -m lib.vibe.cli.main "$@"
}

main "$@"
