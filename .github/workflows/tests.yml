name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-and-test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect test framework
        id: detect
        run: |
          # Detect Python tests
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "requirements.txt" ]; then
            if grep -q "pytest" pyproject.toml 2>/dev/null || \
               grep -q "pytest" requirements.txt 2>/dev/null || \
               [ -d "tests" ] && ls tests/*.py 2>/dev/null; then
              echo "framework=pytest" >> $GITHUB_OUTPUT
              echo "Detected: pytest"
            fi
          fi

          # Detect Node.js tests
          if [ -f "package.json" ]; then
            if grep -q '"vitest"' package.json; then
              echo "framework=vitest" >> $GITHUB_OUTPUT
              echo "Detected: vitest"
            elif grep -q '"jest"' package.json; then
              echo "framework=jest" >> $GITHUB_OUTPUT
              echo "Detected: jest"
            elif grep -q '"test"' package.json; then
              echo "framework=npm-test" >> $GITHUB_OUTPUT
              echo "Detected: npm test"
            fi
          fi

          # Detect Playwright
          if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
            echo "has_playwright=true" >> $GITHUB_OUTPUT
            echo "Detected: playwright"
          fi

      # Python tests with pytest
      - name: Set up Python
        if: steps.detect.outputs.framework == 'pytest'
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        if: steps.detect.outputs.framework == 'pytest'
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" 2>/dev/null || pip install pytest pytest-cov

      - name: Run pytest
        if: steps.detect.outputs.framework == 'pytest'
        run: |
          pytest --cov --cov-report=xml --cov-report=term || true

      # Node.js tests
      - name: Set up Node.js
        if: contains(fromJSON('["vitest", "jest", "npm-test"]'), steps.detect.outputs.framework)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        if: contains(fromJSON('["vitest", "jest", "npm-test"]'), steps.detect.outputs.framework)
        run: npm ci

      - name: Run vitest
        if: steps.detect.outputs.framework == 'vitest'
        run: npm run test -- --coverage || true

      - name: Run jest
        if: steps.detect.outputs.framework == 'jest'
        run: npm test -- --coverage || true

      - name: Run npm test
        if: steps.detect.outputs.framework == 'npm-test'
        run: npm test || true

      # Playwright tests
      - name: Install Playwright
        if: steps.detect.outputs.has_playwright == 'true'
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        if: steps.detect.outputs.has_playwright == 'true'
        run: npx playwright test || true

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage
          path: |
            coverage/
            htmlcov/
            coverage.xml
          if-no-files-found: ignore
          retention-days: 30

      - name: No tests found
        if: steps.detect.outputs.framework == ''
        run: |
          echo "No test framework detected."
          echo "Supported frameworks: pytest, vitest, jest, playwright"
          echo "Add tests to enable automatic testing."
