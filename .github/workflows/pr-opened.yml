# FALLBACK WORKFLOW: Prefer Linear's native GitHub integration instead.
# See: recipes/tickets/linear-github-integration.md
#
# This workflow is for teams that can't use native integration (GitHub Enterprise,
# custom state names, etc.). If using native integration, you can delete this file
# or leave it - it will skip gracefully if LINEAR_API_KEY is not set.
#
# When a PR is opened or reopened, update the associated Linear ticket to "In Review"
# (or the state name configured via LINEAR_IN_REVIEW_STATE repo variable).
# Requires: LINEAR_API_KEY repo secret.
name: PR Opened (Fallback)

on:
  pull_request:
    types: [opened, reopened]

jobs:
  update-ticket:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Extract ticket ID from branch
        id: ticket
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          TICKET=$(echo "$BRANCH" | grep -oE '^[A-Z]+-[0-9]+' || true)
          echo "ticket_id=$TICKET" >> $GITHUB_OUTPUT
          if [ -z "$TICKET" ]; then
            echo "No ticket ID found in branch name '$BRANCH'; skipping Linear update."
          fi

      - name: Update Linear ticket to In Review
        if: steps.ticket.outputs.ticket_id != ''
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_IN_REVIEW_STATE: ${{ vars.LINEAR_IN_REVIEW_STATE }}
          TICKET_ID: ${{ steps.ticket.outputs.ticket_id }}
        run: |
          set -e
          IN_REVIEW_STATE="${LINEAR_IN_REVIEW_STATE:-In Review}"
          if [ -z "$LINEAR_API_KEY" ]; then
            echo "::warning::LINEAR_API_KEY not set; skipping Linear ticket update."
            exit 0
          fi

          # Find issue by identifier (e.g. PROJ-123)
          RESULT=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { issues(filter: { identifier: { eq: \\\"$TICKET_ID\\\" } }, first: 1) { nodes { id, identifier, team { id } } } }\"}")

          if echo "$RESULT" | grep -q '"errors"'; then
            echo "::warning::Linear API error fetching issue: $RESULT"
            exit 0
          fi

          ISSUE_ID=$(echo "$RESULT" | jq -r '.data.issues.nodes[0].id // empty')
          TEAM_ID=$(echo "$RESULT" | jq -r '.data.issues.nodes[0].team.id // empty')

          if [ -z "$ISSUE_ID" ] || [ -z "$TEAM_ID" ]; then
            echo "::warning::Could not find Linear issue or team for $TICKET_ID"
            exit 0
          fi

          # Resolve workflow state by name (case-insensitive)
          STATE_RESULT=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { team(id: \\\"$TEAM_ID\\\") { states { nodes { id, name } } } }\"}")

          if echo "$STATE_RESULT" | grep -q '"errors"'; then
            echo "::warning::Linear API error fetching workflow states: $STATE_RESULT"
            exit 0
          fi

          STATE_ID=$(echo "$STATE_RESULT" | jq -r --arg name "$IN_REVIEW_STATE" '
            .data.team.states.nodes[] | select(.name | ascii_downcase == ($name | ascii_downcase)) | .id
          ' // empty')

          if [ -z "$STATE_ID" ]; then
            echo "::warning::No workflow state named '$IN_REVIEW_STATE' for team; available states may differ."
            exit 0
          fi

          # Update issue state
          UPDATE_RESULT=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"mutation { issueUpdate(id: \\\"$ISSUE_ID\\\", input: { stateId: \\\"$STATE_ID\\\" }) { success issue { identifier state { name } } } }\"}")

          if echo "$UPDATE_RESULT" | grep -q '"errors"'; then
            echo "::warning::Linear API error updating issue: $UPDATE_RESULT"
            exit 0
          fi

          SUCCESS=$(echo "$UPDATE_RESULT" | jq -r '.data.issueUpdate.success // false')
          if [ "$SUCCESS" = "true" ]; then
            echo "Updated Linear ticket $TICKET_ID to state '$IN_REVIEW_STATE'."
          else
            echo "::warning::Linear issueUpdate did not report success: $UPDATE_RESULT"
          fi
